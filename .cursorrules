# GRID - Geometric Resonance Intelligence Driver
# Master Cursor Rules - Agent Behavior Configuration
# Last Updated: February 5, 2026

## üéØ System Identity
You are an AI agent for GRID, a sophisticated geometric resonance intelligence framework. You operate with:
- **Python 3.13+** (strict typing required)
- **Local-only models** (Ollama: embeddings, LLM, safety)
- **Zero external APIs** (no OpenAI, Anthropic, Cohere calls)
- **Strict sandboxing** (MCP with audit logging)
- **100% core test pass rate** (283+ tests)

## üèóÔ∏è Architecture Compliance

### Layered Architecture (Mandatory)
```
Core Layer (NO dependencies upward)
   ‚Üì
Service Layer (depends on core only)
   ‚Üì
Database Layer (SQLAlchemy ORM)
   ‚Üì
API Layer (FastAPI/CLI orchestration)
```

### Layer Boundaries
- Core modules CANNOT import from `application/`, `tools/`, or upper layers
- Services NEVER access database directly (use ORM)
- API routes NEVER contain business logic
- Database layer is read/write only

## üß† 9 Cognition Patterns

Implement features using one or more patterns:
1. **Flow** - Continuous processes, state transitions
2. **Spatial** - Layout, positioning, relationships
3. **Rhythm** - Timing, cycles, repetition intervals
4. **Color** - Categorization, attribute distinction
5. **Repetition** - Recurring structures, templates
6. **Deviation** - Exceptions, anomalies, edge cases
7. **Cause** - Causality, dependencies, triggers
8. **Time** - Temporal ordering, sequences
9. **Combination** - Composite emergence, synthesis

## üîê Security (Non-Negotiable)

### External APIs
- ‚ùå NEVER call OpenAI, Anthropic, Cohere, Hugging Face
- ‚ùå NEVER make HTTP/HTTPS requests without explicit approval
- ‚úÖ USE local Ollama models only
- ‚úÖ ALL network calls audited in `.cursor/mcp_audit.log`

### Path Operations
```python
from src.grid.security.path_validator import PathValidator
validator = PathValidator(base_dir="/grid")
if validator.validate_path(user_path):
    # Safe to proceed
```

### Environment Variables
- ‚úÖ Fetch from environment (fail-fast if missing)
- ‚ùå NO hardcoded secrets
- ‚ùå NO defaults for sensitive values
- ‚úÖ Sanitize before logging

### Code Execution
- ‚úÖ All code runs in MCP sandbox
- ‚úÖ Whitelist commands: uv, pytest, git, python, ruff, black, mypy
- ‚ùå NO system() calls without whitelist
- ‚ùå NO network calls
- Timeout: 30 seconds max

## üì¶ Dependencies & Imports

### Import Discipline
```python
# ‚úÖ Correct: Absolute imports from project
from src.grid.essence.core_state import EssentialState
from src.tools.rag.rag_engine import RAGEngine
from src.cognitive.cognitive_layer import CognitiveEngine

# ‚úÖ Correct: Third-party imports
from pydantic import BaseModel
from sqlalchemy import Column, String

# ‚ùå Wrong: Relative imports (breaks encapsulation)
# ‚ùå Wrong: Circular imports
# ‚ùå Wrong: Wildcard imports (from x import *)
```

### Dependency Management
- Use UV for all package operations
- Pin versions in `pyproject.toml`
- NO pip, NO conda, NO manual venv
- Lock file (`uv.lock`) is canonical

## üß™ Testing Requirements

### Coverage Target
- ‚â•80% overall
- 100% for core/essence modules
- 100% for security modules

### Test Organization
```
tests/
‚îú‚îÄ‚îÄ unit/           # Fast, isolated, no DB
‚îú‚îÄ‚îÄ integration/    # Cross-module, can use DB
‚îú‚îÄ‚îÄ api/           # Endpoint tests
‚îú‚îÄ‚îÄ security/      # Security-specific tests
‚îî‚îÄ‚îÄ unified_fabric/# Event bus tests
```

### Markers
```python
@pytest.mark.unit         # Fast, run always
@pytest.mark.integration  # Slower, optional
@pytest.mark.critical     # Must pass
@pytest.mark.slow         # Skip with -m "not slow"
```

### Test Pattern
```python
def test_something():
    # Arrange
    obj = SystemUnderTest()

    # Act
    result = obj.do_something()

    # Assert
    assert result == expected
```

## üìù Code Style

### Python Style Guide
- **Formatter**: Black (120 char line length)
- **Linter**: Ruff
- **Type Checker**: MyPy (strict mode)

### Type Hints (MANDATORY)
```python
def process_data(
    entity_id: str,
    options: Optional[Dict[str, Any]] = None
) -> Dict[str, Any]:
    """All functions require type hints."""
    pass
```

### Naming Conventions
- **Classes**: `PascalCase` (e.g., `DatabaseConnection`)
- **Functions/Methods**: `snake_case` (e.g., `validate_path`)
- **Constants**: `UPPER_SNAKE_CASE` (e.g., `MAX_RETRIES`)
- **Private**: `_leading_underscore` (e.g., `_internal_method`)

### Error Handling
```python
from src.grid.core.exceptions import GridError, ValidationError

# ‚úÖ Correct
if not data.get("required_field"):
    raise ValidationError("Clear, actionable message with expected format")

# ‚ùå Wrong: Silent failures
# ‚ùå Wrong: Generic exceptions
```

## üõ†Ô∏è Skills System

### Skill Protocol
```python
from typing import Any, Mapping

class Skill(Protocol):
    def run(self, args: Mapping[str, Any]) -> Dict[str, Any]:
        """Execute skill with JSON arguments."""
        ...
```

### Auto-Discovery
- Skills auto-discovered from `src/grid/skills/{domain}/{name}.py`
- No manual registration needed
- Use `python -m grid skills list` to verify

### Available Domains
- `transform.*` - Schema/format transformation
- `context.*` - Context refinement
- `compress.*` - Information compression
- `intelligence.*` - Intelligence analysis
- `safety.*` - Safety validation

## üåç Global Rules, Workflows, and Memory

### Global Rules (All Workspaces)
- Enforce local-only models and no external APIs
- Enforce MCP sandboxing and audit logging
- Enforce strict type hints and code quality gates
- Never persist sensitive data in memory logs

### Global Skills Workflow
- Auto-discover skills from `src/grid/skills/`
- Validate skill interface before execution
- Record skill execution outcomes in audit logs

### Global Workflow Automation
- `code-review` (lint/format/type-check)
- `test-coverage` (coverage ‚â•80%)
- `skill-discovery` (auto-register)
- `security-scan` (local-only audit)

### Global Memory Policy
- Memory is **local-only** and **audit-tracked**
- Retain short-term context in `.cursor/history`
- No external sync or cloud persistence
- Purge on request or on retention limit

## üéØ Database Operations

### ORM Usage
```python
from src.grid.database.models import MyModel
from src.grid.database.session import get_session

async with get_session() as session:
    obj = await session.get(MyModel, id=123)
    await session.commit()
```

### Key Rules
- Always use async context managers
- Never access DB directly from routes (use services)
- Use dependency injection for sessions
- Test mode: `sqlite:///:memory:`
- Migration tool: Alembic

## üìä Events & Async

### Unified Fabric Event Bus
```python
from src.unified_fabric import get_event_bus, Event, EventDomain

event_bus = get_event_bus()

# Subscribe to domain events
@event_bus.subscribe("grid.pattern.created", EventDomain.GRID)
async def handle_created(event: Event):
    pass

# Publish events
await event_bus.publish(Event(
    event_type="grid.pattern.created",
    payload={"pattern": pattern_data},
    source_domain="grid"
))
```

### Domain Routing
- `safety` - Security validation
- `grid` - Core operations
- `coinbase` - External integration (isolated)

## üöÄ Performance Targets

### SLA Compliance
- Core operations: <100ms (0.1s guard)
- API responses: <500ms
- Test suite: <60s total
- Startup time: <5s

### Optimization Principles
- Cache RAG results locally
- Batch database operations
- Use async for I/O
- Monitor `benchmark_metrics.json`

## üìö Reference Resources

### Documentation
- `.cursor/context.md` - Agent context & instructions
- `docs/pattern_language.md` - Pattern theory
- `docs/architecture.md` - System architecture
- `docs/security/SECURITY_ARCHITECTURE.md` - Security design
- `AGENTS_DEVTOOLS_INTEGRATION.md` - DevTools setup
- `.cursor/mcp_config.json` - MCP configuration
- `.cursor/security-policy.json` - Security policy

### Quick Commands
```bash
# Testing
uv run pytest tests/unit/ -v
uv run pytest --cov=src --cov-report=html

# Code Quality
uv run ruff check . --fix
uv run black .
uv run mypy src/ --ignore-missing-imports

# Development
uv run uvicorn application.mothership.main:app --reload

# Skills
python -m grid skills list
python -m grid skills run transform.schema_map --args-json '{}'

# RAG
python -m tools.rag.cli query "How are patterns implemented?"
```

## üîç Pre-Commit Checklist

Before committing ANY code:
- [ ] Unit tests passing: `pytest tests/unit/ -v`
- [ ] Coverage ‚â•80%: `pytest --cov=src`
- [ ] Code linted: `ruff check . --fix`
- [ ] Code formatted: `black .`
- [ ] Type checking: `mypy src/ --ignore-missing-imports`
- [ ] No hardcoded secrets
- [ ] No external API calls
- [ ] Documentation updated
- [ ] Commit message references issue

## üö´ Forbidden Patterns

- ‚ùå `from x import *` (wildcard imports)
- ‚ùå `except:` (bare except clauses)
- ‚ùå `os.system()` (use subprocess with whitelist)
- ‚ùå `eval()`, `exec()` (dynamic code execution)
- ‚ùå Circular imports
- ‚ùå Relative imports crossing modules
- ‚ùå Mutable default arguments
- ‚ùå Global state in modules
- ‚ùå Print statements (use logging)
- ‚ùå TODO without issue number

## ‚úÖ Validation Gates

### Pre-Development
- [ ] Environment setup: `uv sync --group dev --group test`
- [ ] Python interpreter: 3.13+
- [ ] All tests pass: `pytest tests/ -v`
- [ ] Coverage check: ‚â•80%

### During Development
- [ ] Following code style
- [ ] Adding tests
- [ ] Type hints present
- [ ] Docstrings complete
- [ ] No security violations

### Pre-Commit
- [ ] All quality checks pass
- [ ] Tests passing
- [ ] Coverage maintained
- [ ] No secrets
- [ ] Documentation updated

---

**This ruleset is enforced by:**
- MCP servers (sandbox execution)
- Pre-commit hooks (code quality)
- CI/CD pipeline (testing & deployment)
- Security policy (`.cursor/security-policy.json`)

**Non-compliance results in:**
1. Code review rejection
2. Automated rollback
3. Security incident report
