{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Agent Prompts Schema",
  "description": "JSON schema for agent prompt inputs and outputs",
  "definitions": {
    "inventory": {
      "type": "object",
      "required": ["manifest_paths", "modules", "ci_files", "tests", "owners"],
      "properties": {
        "manifest_paths": {
          "type": "array",
          "items": {"type": "string"}
        },
        "modules": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "path"],
            "properties": {
              "name": {"type": "string"},
              "path": {"type": "string"},
              "interface_schema": {"type": ["string", "null"]},
              "version": {"type": ["string", "null"]},
              "owner": {"type": ["string", "null"]},
              "type": {"type": "string", "enum": ["library", "service", "artifact"]}
            }
          }
        },
        "ci_files": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["path", "provider"],
            "properties": {
              "path": {"type": "string"},
              "provider": {"type": "string"},
              "triggers": {"type": "array", "items": {"type": "string"}},
              "stages": {"type": "array", "items": {"type": "string"}}
            }
          }
        },
        "tests": {
          "type": "object",
          "properties": {
            "unit": {
              "type": "object",
              "properties": {
                "files": {"type": "array", "items": {"type": "string"}},
                "runner": {"type": "string"},
                "count": {"type": "integer"}
              }
            },
            "integration": {
              "type": "object",
              "properties": {
                "files": {"type": "array", "items": {"type": "string"}},
                "runner": {"type": "string"},
                "count": {"type": "integer"}
              }
            },
            "contract": {
              "type": "object",
              "properties": {
                "files": {"type": "array", "items": {"type": "string"}},
                "runner": {"type": "string"},
                "count": {"type": "integer"}
              }
            }
          }
        },
        "owners": {
          "type": "object",
          "additionalProperties": {"type": "string"}
        },
        "evidence": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "file": {"type": "string"},
              "line": {"type": "integer"},
              "type": {"type": "string"}
            }
          }
        }
      }
    },
    "gaps": {
      "type": "object",
      "required": ["gaps"],
      "properties": {
        "gaps": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "category", "severity", "description"],
            "properties": {
              "id": {"type": "string"},
              "category": {
                "type": "string",
                "enum": [
                  "missing_interface_schema",
                  "missing_semver",
                  "missing_contract_tests",
                  "missing_ci_stage",
                  "missing_validation",
                  "missing_owner",
                  "missing_metrics"
                ]
              },
              "severity": {"type": "integer", "minimum": 1, "maximum": 5},
              "description": {"type": "string"},
              "impact": {"type": "string"},
              "affected_modules": {"type": "array", "items": {"type": "string"}},
              "minimal_remediation": {"type": "string"},
              "estimated_effort_hours": {"type": "number"},
              "priority": {"type": "string", "enum": ["critical", "high", "medium", "low"]}
            }
          }
        },
        "summary": {
          "type": "object",
          "properties": {
            "total_gaps": {"type": "integer"},
            "critical": {"type": "integer"},
            "high": {"type": "integer"},
            "medium": {"type": "integer"},
            "low": {"type": "integer"}
          }
        }
      }
    },
    "backlog": {
      "type": "object",
      "required": ["backlog", "roadmap"],
      "properties": {
        "backlog": {
          "type": "object",
          "properties": {
            "epics": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["id", "title", "stories"],
                "properties": {
                  "id": {"type": "string"},
                  "title": {"type": "string"},
                  "description": {"type": "string"},
                  "stories": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": ["id", "title", "priority", "effort_hours"],
                      "properties": {
                        "id": {"type": "string"},
                        "title": {"type": "string"},
                        "description": {"type": "string"},
                        "priority": {"type": "string", "enum": ["High", "Medium", "Low"]},
                        "effort_hours": {"type": "number"},
                        "owner": {"type": "string"},
                        "acceptance_criteria": {"type": "array", "items": {"type": "string"}},
                        "validation_commands": {"type": "array", "items": {"type": "string"}},
                        "rollback_plan": {"type": "string"},
                        "dependencies": {"type": "array", "items": {"type": "string"}},
                        "tags": {"type": "array", "items": {"type": "string"}}
                      }
                    }
                  }
                }
              }
            }
          }
        },
        "roadmap": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "duration_weeks": {"type": "integer"},
              "milestones": {"type": "array", "items": {"type": "string"}},
              "stories": {"type": "array", "items": {"type": "string"}},
              "demo": {"type": "string"}
            }
          }
        }
      }
    },
    "executor_output": {
      "type": "object",
      "required": ["task_id", "files", "tests", "pr_text"],
      "properties": {
        "task_id": {"type": "string"},
        "diff": {"type": "string"},
        "files": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["path", "content", "action"],
            "properties": {
              "path": {"type": "string"},
              "content": {"type": "string"},
              "action": {"type": "string", "enum": ["create", "update", "delete"]}
            }
          }
        },
        "tests": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["path", "content"],
            "properties": {
              "path": {"type": "string"},
              "content": {"type": "string"},
              "coverage_target": {"type": "number", "minimum": 0, "maximum": 1}
            }
          }
        },
        "ci_snippet": {
          "type": "object",
          "properties": {
            "file": {"type": "string"},
            "content": {"type": "string"},
            "stage": {"type": "string"},
            "insert_after": {"type": "string"}
          }
        },
        "pr_text": {
          "type": "object",
          "required": ["title", "body"],
          "properties": {
            "title": {"type": "string"},
            "body": {"type": "string"},
            "checklist": {"type": "array", "items": {"type": "string"}}
          }
        },
        "changelog_entry": {"type": "string"},
        "readme_updates": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "section": {"type": "string"},
              "content": {"type": "string"}
            }
          }
        },
        "rollback_commands": {"type": "array", "items": {"type": "string"}},
        "git_commands": {"type": "array", "items": {"type": "string"}}
      }
    },
    "validation_report": {
      "type": "object",
      "required": ["validation_report", "pass"],
      "properties": {
        "validation_report": {
          "type": "object",
          "required": ["timestamp", "task_id", "status"],
          "properties": {
            "timestamp": {"type": "string", "format": "date-time"},
            "task_id": {"type": "string"},
            "status": {"type": "string", "enum": ["pass", "fail", "warning"]},
            "metrics": {
              "type": "object",
              "properties": {
                "contract_coverage": {"type": "number", "minimum": 0, "maximum": 1},
                "unit_test_coverage": {"type": "number", "minimum": 0, "maximum": 1},
                "contract_tests_passing": {"type": "number", "minimum": 0, "maximum": 1},
                "validation_exit_code": {"type": "integer"},
                "integration_tests_passing": {"type": "boolean"}
              }
            },
            "test_results": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "test_name": {"type": "string"},
                  "status": {"type": "string", "enum": ["pass", "fail"]},
                  "duration_ms": {"type": "integer"},
                  "output": {"type": "string"}
                }
              }
            },
            "acceptance_criteria_met": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "criterion": {"type": "string"},
                  "status": {"type": "string", "enum": ["pass", "fail"]}
                }
              }
            }
          }
        },
        "pass": {"type": "boolean"}
      }
    },
    "governance_document": {
      "type": "object",
      "required": ["governance_document"],
      "properties": {
        "governance_document": {
          "type": "object",
          "required": ["change_id", "risk_level"],
          "properties": {
            "change_id": {"type": "string"},
            "risk_level": {"type": "string", "enum": ["low", "medium", "high", "critical"]},
            "pre_deploy_checklist": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "category": {"type": "string"},
                  "items": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "item": {"type": "string"},
                        "status": {"type": "string", "enum": ["pending", "pass", "fail"]}
                      }
                    }
                  }
                }
              }
            },
            "approval_template": {
              "type": "object",
              "properties": {
                "required_approvers": {"type": "array", "items": {"type": "string"}},
                "approval_criteria": {"type": "array", "items": {"type": "string"}}
              }
            },
            "canary_strategy": {
              "type": "object",
              "properties": {
                "enabled": {"type": "boolean"},
                "traffic_percentage": {"type": "integer", "minimum": 1, "maximum": 100},
                "monitoring_duration_minutes": {"type": "integer"}
              }
            },
            "rollback_steps": {"type": "array", "items": {"type": "string"}},
            "audit_log_format": {"type": "object"}
          }
        }
      }
    }
  }
}
