version: '3.9'

# Production overrides for docker-compose.yml
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  postgres:
    # Use external managed PostgreSQL in production
    # Uncomment and configure:
    # environment:
    #   DATABASE_URL: postgresql+asyncpg://user:pass@managed-db.example.com:5432/grid_prod

    # Or use with persistent backup
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: always
    # Production resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    # Production logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  chroma:
    restart: always
    environment:
      CHROMA_SQLITE_CHECKPOINT_ENABLED: 'true'
    volumes:
      - chroma_prod_data:/chroma/data
    # Production resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    # Production logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  ollama:
    restart: always
    environment:
      OLLAMA_HOST: 0.0.0.0:11434
    volumes:
      - ollama_prod_data:/root/.ollama
    # Pre-load models (customize as needed)
    # entrypoint: sh -c "ollama pull nomic-embed-text-v2-moe:latest && ollama pull ministral:latest && ollama serve"
    # Production resource limits
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
    # Production logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  mothership-api:
    # Use production image
    image: ghcr.io/your-org/grid:latest

    # Do not start by default; enable explicitly with: docker compose --profile api ...
    profiles:
      - api

    # Restart policy for reliability
    restart: always

    # Resource limits for multi-container environments
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

    environment:
      # Override with production secrets
      DEBUG: "false"
      GRID_LOG_LEVEL: WARNING
      # POSTGRES_PASSWORD: <use-secrets-manager>
      # CORS_ORIGINS: https://yourdomain.com

    # Remove volume mounts in production (use image only)
    volumes: []

    # Use external logging driver
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    restart: always
    volumes:
      - redis_prod_data:/data
    # Production resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    # Production logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  postgres_prod_data:
    driver: local
  chroma_prod_data:
    driver: local
  ollama_prod_data:
    driver: local
  redis_prod_data:
    driver: local
