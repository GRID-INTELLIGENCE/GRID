# Security Configuration for MCP Gateway

# Rate limiting
limit_req_zone $binary_remote_addr zone=mcp_api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=mcp_auth:10m rate=5r/s;

# Security headers
add_header X-Frame-Options DENY always;
add_header X-Content-Type-Options nosniff always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" always;

# API authentication
map $http_authorization $mcp_service {
    default "";
    ~Bearer\s+(.+)$ $1;
}

# MCP Server upstreams
upstream mcp_filesystem {
    server grid-mcp-filesystem-secure:8080;
}

upstream mcp_memory {
    server grid-mcp-memory-secure:8080;
}

upstream mcp_postgres {
    server grid-mcp-postgres-secure:8080;
}

upstream mcp_playwright {
    server grid-mcp-playwright-secure:8080;
}

upstream mcp_database {
    server grid-mcp-database-secure:8080;
}

# MCP API routes with authentication
server {
    listen 80;
    server_name localhost;

    # Health check endpoint (no auth required)
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # MCP Fileservice API
    location /api/filesystem/ {
        limit_req zone=mcp_api burst=20 nodelay;

        # API key validation (simplified)
        if ($mcp_service = "") {
            return 401;
        }

        proxy_pass http://mcp_filesystem/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # MCP Memory API
    location /api/memory/ {
        limit_req zone=mcp_api burst=20 nodelay;

        if ($mcp_service = "") {
            return 401;
        }

        proxy_pass http://mcp_memory/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # MCP PostgreSQL API
    location /api/postgres/ {
        limit_req zone=mcp_api burst=20 nodelay;

        if ($mcp_service = "") {
            return 401;
        }

        proxy_pass http://mcp_postgres/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # MCP Playwright API
    location /api/playwright/ {
        limit_req zone=mcp_api burst=10 nodelay;

        if ($mcp_service = "") {
            return 401;
        }

        proxy_pass http://mcp_playwright/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # MCP Database API
    location /api/database/ {
        limit_req zone=mcp_api burst=20 nodelay;

        if ($mcp_service = "") {
            return 401;
        }

        proxy_pass http://mcp_database/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Default response
    location / {
        return 404;
    }
}
