version: '3.8'

services:
  # Redis for caching and rate limiting
  redis:
    image: redis:7-alpine
    container_name: arena-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - arena-network

  # RabbitMQ for event bus
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: arena-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: arena
      RABBITMQ_DEFAULT_PASS: arena123
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - arena-network

  # API Gateway
  api-gateway:
    build:
      context: ../../
      dockerfile: docker/arena-modernization/Dockerfile.gateway
    container_name: arena-api-gateway
    ports:
      - "8000:8000"
    environment:
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=info
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ../../src:/app/src
    networks:
      - arena-network
    restart: unless-stopped

  # Service Mesh Registry
  service-mesh:
    build:
      context: ../../
      dockerfile: docker/arena-modernization/Dockerfile.mesh
    container_name: arena-service-mesh
    ports:
      - "8500:8500"
    environment:
      - LOG_LEVEL=info
    volumes:
      - ../../src:/app/src
    networks:
      - arena-network
    restart: unless-stopped

  # Event Bus Service
  event-bus:
    build:
      context: ../../
      dockerfile: docker/arena-modernization/Dockerfile.eventbus
    container_name: arena-event-bus
    environment:
      - REDIS_URL=redis://redis:6379
      - RABBITMQ_URL=amqp://arena:arena123@rabbitmq:5672
      - LOG_LEVEL=info
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    volumes:
      - ../../src:/app/src
      - event_data:/app/events
    networks:
      - arena-network
    restart: unless-stopped

  # AI/ML Intelligence System
  intelligence-system:
    build:
      context: ../../
      dockerfile: docker/arena-modernization/Dockerfile.ai
    container_name: arena-intelligence
    environment:
      - REDIS_URL=redis://redis:6379
      - REGION=southeast_asia
      - AI_SAFETY_LEVEL=permitted
      - LOG_LEVEL=info
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ../../src:/app/src
      - model_data:/app/models
      - experiment_data:/app/experiments
    networks:
      - arena-network
    restart: unless-stopped

  # Arena Orchestrator (Main Controller)
  arena-orchestrator:
    build:
      context: ../../
      dockerfile: docker/arena-modernization/Dockerfile.orchestrator
    container_name: arena-orchestrator
    ports:
      - "9000:9000"
    environment:
      - GATEWAY_PORT=8000
      - MESH_REGISTRY_PORT=8500
      - REDIS_URL=redis://redis:6379
      - RABBITMQ_URL=amqp://arena:arena123@rabbitmq:5672
      - REGION=southeast_asia
      - ENABLE_AI_ML=true
      - ENABLE_MONITORING=true
      - LOG_LEVEL=info
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      api-gateway:
        condition: service_started
      service-mesh:
        condition: service_started
      event-bus:
        condition: service_started
      intelligence-system:
        condition: service_started
    volumes:
      - ../../src:/app/src
    networks:
      - arena-network
    restart: unless-stopped

  # Monitoring Dashboard
  monitoring:
    build:
      context: ../../
      dockerfile: docker/arena-modernization/Dockerfile.monitoring
    container_name: arena-monitoring
    ports:
      - "3000:3000"
    environment:
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=info
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ../../src:/app/src
    networks:
      - arena-network
    restart: unless-stopped

volumes:
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
  event_data:
    driver: local
  model_data:
    driver: local
  experiment_data:
    driver: local

networks:
  arena-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
