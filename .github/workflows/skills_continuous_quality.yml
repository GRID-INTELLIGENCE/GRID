name: Skills Continuous Quality
on:
  schedule:
    - cron: '0 */4 * * *'  # Every 4 hours
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode (dry-run)'
        required: false
        default: 'false'
  push:
    branches: [main, architecture/stabilization]
    paths:
      - 'src/grid/skills/**'
      - 'tests/skills/**'
  pull_request:
    branches: [main, architecture/stabilization]
    paths:
      - 'src/grid/skills/**'
      - 'tests/skills/**'

env:
  PYTHON_VERSION: '3.13'
  COVERAGE_TARGET: '80'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: |
          uv sync --group dev --group test

      - name: Run unit tests with coverage
        run: |
          uv run pytest tests/unit/ -v \
            --cov=src/grid/skills \
            --cov-report=term-missing \
            --cov-fail-under=${{ env.COVERAGE_TARGET }} \
            --timeout=300

      - name: Check coverage threshold
        run: |
          coverage_report=$(uv run pytest tests/unit/ --cov-report=term-missing --tb=no -q)
          if [[ $(echo "$coverage_report" | grep -oP '\d+%' | tail -1 | sed 's/%//') -lt 80 ]]; then
            echo "::warning::Coverage below 80% threshold::$(echo $coverage_report | grep -oP '\d+%')"
          fi

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: skills-unit
          fail_ci_if_error: true

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: |
          uv sync --group test

      - name: Run integration tests
        run: |
          uv run pytest tests/integration/ -v \
            --timeout=600

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            test-results/
            pytest-html/
          retention-days: 30

  signal-quality-check:
    name: Signal Quality Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          uv sync

      - name: Analyze signal quality
        run: |
          python -c "
          from grid.skills.nsr_tracker import NSRTracker
          from grid.skills.signal_classification import SignalClassifier

          nsr_tracker = NSRTracker()
          signal_classifier = SignalClassifier()

          current_nsr = nsr_tracker.get_current_nsr_details()

          print(f'Current NSR: {current_nsr[\"nsr\"]:.3%}')
          print(f'Threshold: {current_nsr[\"threshold\"]:.1%}')

          if current_nsr.get('threshold_reached', False):
              print('‚ö†Ô∏è HIGH NOISE DETECTED')
              exit(1)
          elif current_nsr.get('nsr', 0) > 0.07:
              print('‚ö†Ô∏è Elevated noise detected')
              exit(1)
          else:
              print('‚úÖ Noise levels acceptable')
          "

      - name: Upload quality report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signal-quality-report
          path: /tmp/signal_quality_report.json
          retention-days: 7

  performance-regression-check:
    name: Performance Regression Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          uv sync

      - name: Check for regressions
        run: |
          python -c "
          from grid.skills.performance_guard import PerformanceGuard
          from grid.skills.intelligence_inventory import IntelligenceInventory

          guard = PerformanceGuard()
          inventory = IntelligenceInventory()

          # Check all skills for regressions
          skills_with_regression = []

          from grid.skills.registry import default_registry
          for skill in default_registry.list():
              summary = inventory.get_skill_summary(skill.id)
              if not summary:
                  continue

              # Check for regression
              regression = inventory.check_regression(
                  skill.id,
                  {'p50_ms': summary.p50_latency_ms}
              )

              if regression:
                  skills_with_regression.append({
                      'skill_id': skill.id,
                      'current_p50': summary.p50_latency_ms,
                      'degradation_pct': regression.get('p50_ms', {}).get('degradation_pct', 0)
                  })

          if skills_with_regression:
              print(f'‚ùå REGRESSIONS DETECTED:')
              for reg in skills_with_regression:
                  print(f\"  - {reg['skill_id']}: {reg['degradation_pct']:+.1f}% degradation\")
              exit(1)
          else:
              print('‚úÖ No regressions detected')
          "

      - name: Comment on regressions
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            if (process.env.TEST_MODE !== 'true') {
              console.log("Performance regression detected. Review diagnostics.");
            }

  nightly-full-tests:
    name: Nightly Full Test Suite
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          uv sync --group test

      - name: Run complete test suite
        run: |
          uv run pytest tests/ -v \
            --timeout=3600 \
            --junitxml=junit.xml

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: nightly-test-results
          path: |
            junit.xml
            htmlcov/
          retention-days: 30

      - name: Create nightly report
        run: |
          python -c "
          from grid.skills.diagnostics import SkillsDiagnostics

          diagnostics = SkillsDiagnostics()
          report = diagnostics.run_full_diagnostics()

          import json
          with open('/tmp/nightly_report.json', 'w') as f:
              json.dump(report.__dict__, f, indent=2)
          print('Nightly report generated')
          "

      - name: Upload nightly report
        uses: actions/upload-artifact@v4
        with:
          name: nightly-diagnostic-report
          path: /tmp/nightly_report.json
          retention-days: 90

  threshold-tuning:
    name: Auto-Tune Thresholds
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          uv sync

      - name: Auto-tune NSR threshold
        run: |
          python -c "
          from grid.skills.nsr_tracker import NSRTracker

          nsr_tracker = NSRTracker()

          # Check if we should tighten threshold
          details = nsr_tracker.get_current_nsr_details()

          # Simple logic for tightening in the script context
          if details['nsr'] < 0.05 and details['threshold'] > 0.05:
              print(f'üéØ Auto-tuning NSR threshold: 10% ‚Üí 5%')

              # Create result for PR
              import json
              with open('/tmp/threshold_tuning.json', 'w') as f:
                  json.dump({
                      'recommendation': 'Tighten NSR threshold from 10% to 5%',
                      'current_threshold': 0.1,
                      'recommended_threshold': 0.05,
                      'reason': 'NSR has been stable below 5% for the observation window',
                      'action_required': 'manual_approval'
                  }, f, indent=2)
          else:
              print('‚úÖ No threshold tuning needed')
          "

      - name: Create pull request for threshold change
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          title: '[Auto-tune] Tighten NSR threshold 10% ‚Üí 5%'
          body: |
            Auto-tuning recommends tightening NSR threshold due to stable noise levels below 5%.

            Details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          branch: auto-tune-nsr-threshold
          delete-branch: true
