# =============================================================================
# GRID — Release & Publishing Pipeline
# =============================================================================
# Consolidated from: release.yaml, publish-pypi.yml
# Automated release workflow for versioning, changelog generation, and
# publishing to PyPI for both grid-intelligence and grid-safety packages.
#
# Triggers:
#   - Tag push: v*.*.* (grid-intelligence) or grid-safety-* (grid-safety)
#   - Manual dispatch with version bump type
# =============================================================================

name: Release & Publish

on:
  push:
    tags:
      - "v*.*.*"
      - "grid-safety-*"
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: "Create as pre-release"
        required: false
        type: boolean
        default: false
      dry_run:
        description: "Dry run (don't publish)"
        required: false
        type: boolean
        default: false
      package:
        description: "Package to release"
        required: true
        type: choice
        options:
          - grid-intelligence
          - grid-safety
        default: grid-intelligence

permissions:
  contents: write
  id-token: write

env:
  PYTHONUNBUFFERED: "1"
  PYTHONDONTWRITEBYTECODE: "1"

jobs:
  # =========================================================================
  # PREPARE - Determine Version & Generate Changelog
  # =========================================================================
  prepare:
    name: "Prepare Release"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      package: ${{ steps.version.outputs.package }}

    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Install uv"
        uses: astral-sh/setup-uv@v7.3.0
        with:
          version: "0.10.4"
          python-version: "3.13"
          enable-cache: false

      - name: "Determine Version & Package"
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Tag push
            if [[ "${GITHUB_REF}" == refs/tags/grid-safety-* ]]; then
              PACKAGE="grid-safety"
              VERSION=${GITHUB_REF#refs/tags/grid-safety-}
            else
              PACKAGE="grid-intelligence"
              VERSION=${GITHUB_REF#refs/tags/v}
            fi
            TAG=${GITHUB_REF#refs/tags/}
          else
            # Manual dispatch — use tomllib (stdlib, Python 3.11+)
            PACKAGE="${{ github.event.inputs.package }}"
            if [[ "$PACKAGE" == "grid-safety" ]]; then
              CURRENT=$(uv run python -c "import tomllib; print(tomllib.load(open('safety/pyproject.toml','rb'))['project']['version'])" 2>/dev/null || echo "1.0.0")
            else
              CURRENT=$(uv run python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")
            fi
            IFS='.' read -r -a parts <<< "$CURRENT"
            MAJOR=${parts[0]}
            MINOR=${parts[1]}
            PATCH=${parts[2]}

            case "${{ github.event.inputs.version_bump }}" in
              major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
              minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
              patch) PATCH=$((PATCH + 1)) ;;
            esac

            VERSION="${MAJOR}.${MINOR}.${PATCH}"
            if [[ "${{ github.event.inputs.prerelease }}" == "true" ]]; then
              VERSION="${VERSION}-rc.1"
            fi
            if [[ "$PACKAGE" == "grid-safety" ]]; then
              TAG="grid-safety-${VERSION}"
            else
              TAG="v${VERSION}"
            fi
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "package=${PACKAGE}" >> $GITHUB_OUTPUT
          echo "::notice::Package: ${PACKAGE}, Version: ${VERSION}, Tag: ${TAG}"

      - name: "Generate Changelog"
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [[ -n "$LAST_TAG" ]]; then
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          fi
          echo -e "## What's Changed in ${{ steps.version.outputs.tag }}\n\n${COMMITS}" > RELEASE_NOTES.md
          cat RELEASE_NOTES.md

      - name: "Upload Release Notes"
        uses: actions/upload-artifact@v6
        with:
          name: release-notes
          path: RELEASE_NOTES.md

  # =========================================================================
  # TEST - Run Tests Before Release
  # =========================================================================
  test:
    name: "Test Before Release"
    runs-on: ubuntu-latest
    needs: [prepare]
    if: needs.prepare.outputs.package == 'grid-intelligence'

    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v6

      - name: "Install uv"
        uses: astral-sh/setup-uv@v7.3.0
        with:
          version: "0.10.4"
          python-version: "3.13"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: "Install dependencies"
        run: uv sync --frozen --group test

      - name: "Run Tests"
        run: uv run pytest tests/unit -v --tb=short -m "not slow"
        env:
          PYTHONPATH: .
          BLOCKER_DISABLED: "1"
          GRID_ENVIRONMENT: testing

  # =========================================================================
  # BUILD - Package Building
  # =========================================================================
  build:
    name: "Build Package"
    runs-on: ubuntu-latest
    needs: [prepare, test]
    if: always() && (needs.test.result == 'success' || needs.prepare.outputs.package == 'grid-safety')

    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v6

      - name: "Install uv"
        uses: astral-sh/setup-uv@v7.3.0
        with:
          version: "0.10.4"
          python-version: "3.13"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: "Install build tools"
        run: |
          uv venv
          uv pip install build twine

      - name: "Update Version (grid-intelligence)"
        if: github.event_name == 'workflow_dispatch' && needs.prepare.outputs.package == 'grid-intelligence'
        run: |
          uv run python -c "
          import tomllib, re
          with open('pyproject.toml', 'rb') as f:
              current = tomllib.load(f)['project']['version']
          with open('pyproject.toml', 'r') as f:
              content = f.read()
          content = content.replace(f'version = \"{current}\"', 'version = \"${{ needs.prepare.outputs.version }}\"', 1)
          with open('pyproject.toml', 'w') as f:
              f.write(content)
          "

      - name: "Build grid-intelligence"
        if: needs.prepare.outputs.package == 'grid-intelligence'
        run: |
          uv run python -m build
          ls -la dist/

      - name: "Build grid-safety"
        if: needs.prepare.outputs.package == 'grid-safety'
        working-directory: safety
        run: |
          uv venv
          uv pip install build
          uv run python -m build --wheel
          ls -la dist/

      - name: "Verify Package"
        run: |
          if [[ "${{ needs.prepare.outputs.package }}" == "grid-safety" ]]; then
            uv run twine check safety/dist/*
          else
            uv run twine check dist/*
          fi

      - name: "Upload Build Artifacts"
        uses: actions/upload-artifact@v6
        with:
          name: dist-packages
          path: |
            dist/
            safety/dist/

  # =========================================================================
  # PUBLISH - PyPI Publishing
  # =========================================================================
  publish-pypi:
    name: "Publish to PyPI"
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: always() && needs.build.result == 'success' && github.event.inputs.dry_run != 'true'
    environment:
      name: pypi
      url: ${{ needs.prepare.outputs.package == 'grid-safety' && 'https://pypi.org/project/grid-safety/' || 'https://pypi.org/project/grid-intelligence/' }}

    steps:
      - name: "Download Artifacts"
        uses: actions/download-artifact@v7
        with:
          name: dist-packages
          path: .

      - name: "Publish to PyPI"
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          attestations: false
          skip-existing: true
          verbose: true

  # =========================================================================
  # RELEASE - Create GitHub Release
  # =========================================================================
  release:
    name: "Create GitHub Release"
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: always() && needs.build.result == 'success'

    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v6

      - name: "Download Artifacts"
        uses: actions/download-artifact@v7
        with:
          name: dist-packages
          path: .

      - name: "Download Release Notes"
        uses: actions/download-artifact@v7
        with:
          name: release-notes

      - name: "Create Tag"
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          TAG="${{ needs.prepare.outputs.tag }}"
          if git ls-remote --tags origin "${TAG}" | grep -q "${TAG}"; then
            echo "Tag ${TAG} already exists on origin. Skipping tag creation."
            exit 0
          fi
          git tag -a "${TAG}" -m "Release ${TAG}"
          git push origin "${TAG}"

      - name: "Create GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: "GRID ${{ needs.prepare.outputs.tag }}"
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: dist/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =========================================================================
  # SUMMARY - Release Summary
  # =========================================================================
  summary:
    name: "Release Summary"
    runs-on: ubuntu-latest
    needs: [prepare, release]
    if: always()

    steps:
      - name: "Release Summary"
        run: |
          echo "## GRID Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** ${{ needs.prepare.outputs.package }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Grid continues to evolve." >> $GITHUB_STEP_SUMMARY
