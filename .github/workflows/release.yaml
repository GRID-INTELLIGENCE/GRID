# =============================================================================
# GRID â€” Release & Publishing Pipeline
# =============================================================================
# Automated release workflow for versioning, changelog generation, and
# publishing to PyPI.
#
# Triggers:
#   - Manual dispatch with version bump type
#   - Tag push matching v*.*.*
# =============================================================================

name: Release & Publish

on:
  push:
    tags:
      - "v*.*.*"

  workflow_dispatch:
    inputs:
      version_bump:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: "Create as pre-release"
        required: false
        type: boolean
        default: false
      dry_run:
        description: "Dry run (don't publish)"
        required: false
        type: boolean
        default: false

env:
  PYTHONUNBUFFERED: "1"
  PYTHONDONTWRITEBYTECODE: "1"

jobs:
  # ---------------------------------------------------------------------------
  # Validate & Prepare Release
  # ---------------------------------------------------------------------------
  prepare:
    name: "Prepare Release"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}

    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: "Install uv"
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: "Install tools"
        run: |
          uv tool install toml

      - name: "Determine Version"
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            TAG=${GITHUB_REF#refs/tags/}
          else
            CURRENT=$(uv run python -c "import toml; print(toml.load('pyproject.toml')['project']['version'])")
            IFS='.' read -r -a parts <<< "$CURRENT"
            MAJOR=${parts[0]}
            MINOR=${parts[1]}
            PATCH=${parts[2]}

            case "${{ github.event.inputs.version_bump }}" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac

            VERSION="${MAJOR}.${MINOR}.${PATCH}"
            if [[ "${{ github.event.inputs.prerelease }}" == "true" ]]; then
              VERSION="${VERSION}-rc.1"
            fi
            TAG="v${VERSION}"
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
          echo "Tag: ${TAG}"

      - name: "Generate Changelog"
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [[ -n "$LAST_TAG" ]]; then
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          fi
          CHANGELOG="## What's Changed in ${{ steps.version.outputs.tag }}\n\n${COMMITS}"
          echo -e "$CHANGELOG" > RELEASE_NOTES.md
          cat RELEASE_NOTES.md

      - name: "Upload Release Notes"
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: RELEASE_NOTES.md

  # ---------------------------------------------------------------------------
  # Run Tests
  # ---------------------------------------------------------------------------
  test:
    name: "Test Before Release"
    runs-on: ubuntu-latest
    needs: [prepare]

    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4

      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: "Install uv"
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: "Install dependencies"
        run: |
          uv sync --frozen

      - name: "Run Tests"
        run: uv run pytest tests/unit -v --tb=short -m "not slow"
        env:
          PYTHONPATH: circuits:.
          BLOCKER_DISABLED: "1"
          GRID_ENVIRONMENT: testing

  # ---------------------------------------------------------------------------
  # Build Package
  # ---------------------------------------------------------------------------
  build:
    name: "Build Package"
    runs-on: ubuntu-latest
    needs: [prepare, test]

    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4

      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: "Install uv"
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: "Install build tools"
        run: |
          uv tool install build twine toml

      - name: "Update Version"
        if: github.event_name == 'workflow_dispatch'
        run: |
          uv run python -c "
          import toml
          with open('pyproject.toml', 'r') as f:
              config = toml.load(f)
          config['project']['version'] = '${{ needs.prepare.outputs.version }}'
          with open('pyproject.toml', 'w') as f:
              toml.dump(config, f)
          "

      - name: "Build Package"
        run: |
          uv run python -m build
          ls -la dist/

      - name: "Verify Package"
        run: uv run twine check dist/*

      - name: "Upload Build Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: dist-packages
          path: dist/

  # ---------------------------------------------------------------------------
  # Publish to PyPI
  # ---------------------------------------------------------------------------
  publish-pypi:
    name: "Publish to PyPI"
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: github.event.inputs.dry_run != 'true'
    environment:
      name: pypi
      url: https://pypi.org/project/grid/

    permissions:
      id-token: write

    steps:
      - name: "Download Artifacts"
        uses: actions/download-artifact@v4
        with:
          name: dist-packages
          path: dist/

      - name: "Publish to PyPI"
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true
          verbose: true

  # ---------------------------------------------------------------------------
  # Create GitHub Release
  # ---------------------------------------------------------------------------
  release:
    name: "Create GitHub Release"
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: always() && needs.build.result == 'success'

    permissions:
      contents: write

    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4

      - name: "Download Artifacts"
        uses: actions/download-artifact@v4
        with:
          name: dist-packages
          path: dist/

      - name: "Download Release Notes"
        uses: actions/download-artifact@v4
        with:
          name: release-notes

      - name: "Create Tag"
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag -a "${{ needs.prepare.outputs.tag }}" -m "Release ${{ needs.prepare.outputs.tag }}"
          git push origin "${{ needs.prepare.outputs.tag }}"

      - name: "Create GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: "GRID ${{ needs.prepare.outputs.tag }}"
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: dist/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ---------------------------------------------------------------------------
  # Summary
  # ---------------------------------------------------------------------------
  summary:
    name: "Release Summary"
    runs-on: ubuntu-latest
    needs: [prepare, release]
    if: always()

    steps:
      - name: "Release Summary"
        run: |
          echo "## GRID Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Grid continues to evolve." >> $GITHUB_STEP_SUMMARY
